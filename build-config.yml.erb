---
targets:
<%
  platforms = %w[sid-amd64 bullseye-amd64 buster-amd64]
  versions = %w[2.7.7 3.0.5 3.1.3]
  matrix = platforms.product(versions)

  matrix.each do |platform, version|
    case platform
    when 'sid-amd64'
      image = 'minimum2scp/ruby:latest'
    when 'bullseye-amd64'
      image = 'minimum2scp/ruby-bullseye:latest'
    when 'buster-amd64'
      image = 'minimum2scp/ruby-buster:latest'
    end

    case version
    when '3.1.3'
      update_rubygems = false
      install_bundler = false
      install_legacy_bundler = '1.17.3'
      ruby_configure_opts = '--enable-load-relative'
    when '3.0.5', '2.7.7'
      update_rubygems = '3.3.26'
      install_bundler = false
      install_legacy_bundler = '1.17.3'
      ruby_configure_opts = '--enable-load-relative'
    end

    if platform == 'sid-amd64' && ( version == '3.0.5' || version == '2.7.7' )
      openssl = { version: '1.1.1s' }
    else
      openssl = nil
    end

    definition = {
      '3.1.3' => 'https://cache.ruby-lang.org/pub/tmp/ruby-3.1.3-draft.tar.gz#5ea498a35f4cd15875200a52dde42b6eb179e1264e17d78732c3a57cd1c6ab9e',
      '3.0.5' => 'https://cache.ruby-lang.org/pub/tmp/ruby-3.0.5-draft.tar.gz#9afc6380a027a4fe1ae1a3e2eccb6b497b9c5ac0631c12ca56f9b7beb4848776',
      '2.7.7' => 'https://cache.ruby-lang.org/pub/tmp/ruby-2.7.7-draft.tar.gz#e10127db691d7ff36402cfe88f418c8d025a3f1eea92044b162dd72f0b8c7b90',
    }[version]

-%>
  - image: <%= image %>
    platform: <%= platform %>
    version: <%= version %>
    <%- if openssl -%>
    openssl:
      version: <%= openssl[:version] %>
    <%- end -%>
    <%- if definition -%>
    src: '<%= definition %>'
    <%- end -%>

    envs:
      RUBY_CONFIGURE_OPTS: <%= ruby_configure_opts.dump %>

    before_build:
      ## assert no-merged-usr (see https://github.com/minimum2scp/dockerfiles/pull/191)
      - if [ -L /bin -o -L /lib -o -L /sbin ]; then exit 1; fi

    after_build:
      - rbenv global <%= version %>
      - ruby --version
      - gem --version
      <%- if update_rubygems -%>
      - gem update --system <%= update_rubygems %> -N
      - gem --version
      <%- end -%>
      <%- if install_legacy_bundler -%>
      - gem install bundler --version <%= install_legacy_bundler %> -f -N
      <%- end -%>
      <%- if install_bundler -%>
      - gem install bundler --version <%= install_bundler %> -f -N
      <%- end -%>
      - gem install pry pry-doc pry-coolline -N

<% end %>
